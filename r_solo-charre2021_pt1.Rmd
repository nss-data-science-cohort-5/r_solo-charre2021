---
title: "R_Solo_charre-2021-pt1"
output: html_notebook
---

## Tidyverse Solo Exercise

In this project, you'll practice working with data using the tidyverse libraries. 
You'll be working with data on each of 145 school districts and the State of Tennessee. This data contains, for the 2014-2015 school year:
* Proficiency rates on state tests
* Student demographics
* Chronic absenteeism
* Discipline (suspension, expulsion) rates
* High school graduation, dropout rates
* Average ACT composite scores
* A region in Tennessee  

Create an RMarkdown file to answer the following questions.

```{r}
library(tidyverse)
library(viridis)
```


1. Read in `districts.csv` into a tibble named `districts`. How many rows and columns does it contain? **Response to Text Question: Districts contains 146 rows and 27 columns.**

```{r}
districts <- read_csv('data/districts.csv')
str(districts)
```


2. Notice that the first row corresponds to the whole State of Tennessee. Remove this row and save the result back to `districts`.

```{r}
districts <-
  districts %>% 
  filter(system_name != 'State of Tennessee')
```



3. How many districts have a proficiency rate of at least 80% for both alg_1 and eng_1? **Response to Text Question: There are only 13.**

```{r}
districts %>% 
  filter(alg_1 >= 80 & eng_1 >= 80) %>% 
  count()
```


4. How many districts have a proviciency rate less than 50% for either alg_1 or eng_1? **Response to Text Question: There are 8.**

```{r}
districts %>%
  filter(alg_1 < 50 | eng_1 < 50) %>% 
  count()
```


5. Which district has the lowest graduation rate? **The Tennessee School for the Blind.**

```{r}
districts %>% 
  arrange(grad) %>% 
  top_n(-1, grad)
```


6. Which district has the highest dropout rate? **The Achievement School District.**

```{r}
districts %>% 
  arrange(desc(dropout)) %>% 
  top_n(1, dropout)
```


7. Within the Mid Cumberland region, which district has the highest ACT composite? **Williamson County.**

```{r}
districts %>% 
  filter(region == "Mid Cumberland") %>% 
  arrange(desc(act_composite)) %>% 
  top_n(1, act_composite)
```


8. Create a histogram showing the distribution of graduation rates. What can you say about this distribution? **Definitely left skewed, with relatively high graduation rates across the state with a few extremely low outliers.**

```{r}
ggplot(districts, aes(x = grad, fill = region)) + 
  geom_histogram(bins = 30, position = "stack") +
  xlim(0, 100) + 
  labs(x = "Graduation Rate", 
       y = "Count of School Districts", 
       title = "Histogram of Graduation Rate Distributions (Stacked by Region)",
       fill = "Region") + 
  scale_fill_brewer() +
  theme(panel.background = element_rect(fill = "#fbe3b2"),
        panel.grid.minor = element_blank())
```


9. Create a scatter plot to compare alg_1 proficiency rates to alg_2 rates. What do you notice? **That proficiency in one subject is positively correlated with the other, but that proficiency in Algebra 1 is greater overall.** Facet this plot by region. Does anything stand out when you facet the plots? **Not particularly. The mix between regions is pretty thorough, and the positive correlation appears to hold for each region, except for the Upper Cumberland.**

```{r}
ggplot(districts, aes(x = alg_1, y = alg_2, size = enrollment)) + 
  geom_point(position = "jitter", shape = 1) + 
  facet_wrap(facets = vars(region), shrink = FALSE, scales = "free") +
  xlim(0, 100) +
  ylim(0, 100) +
  labs(x = "Algebra 1 Proficiency Rates", 
       y = "Algebra 2 Proficiency Rates", 
       title = "Algebra 1 vs. 2 Proficiency Rates by Region")
```

10. Create a bar chart showing the total enrollment by region. Which region has the highest total enrollment? Which has the smallest?

```{r}
ggplot(districts, aes(x = region, y = enrollment)) + 
  geom_col(width = 0.5, fill = "black") +
  labs(x = "Region", 
       y = "Enrollment", 
       title = "Total Enrollment by Region") +
  scale_y_continuous(labels = scales::comma) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90),
        plot.title = element_text(hjust = 0.5))
```


11. When creating this bar chart you may have noticed that some districts have missing enrollment values. For how many districts is this the case? **4**

```{r}
districts %>% 
  filter(is.na(enrollment)) %>% 
  count()
```


12. What is the mean graduation rate across all districts? **Roughly 90%.** What might be wrong with using just the regular mean to assess average graduation rates? **It may be unrepresentative of the true population, since the enrollment of certain districts is likely much larger than others, which should be given more weight.**

```{r}
districts %>% 
  filter(!is.na(grad)) %>% 
  summarize(mean_grad = mean(grad))
```


13. Redo the previous question but use a weighted average (`weighted.mean`) graduation across all districts, weighing by enrollment. How much does this change your answer? **It shifts the mean about three percentage points downwards.** Can you explain using the data the reason for the big change from using the mean? **Shelby County and Davidson County are the largest school districts in the state and have substantially lower than non-weighted average graduation rates than other school districts.**

```{r}
districts %>% 
  filter(!is.na(grad), !is.na(enrollment)) %>% 
  summarize(weight_mean_grad = weighted.mean(grad, enrollment))
```


14. Create a boxplot showing enrollment rates per region. Does anything stand out? **All regions have fairly consistent enrollment with at least one extreme outlier except for in the Mid Cumberland region, which has a enormous interquartile range.**

```{r}
ggplot(districts, aes(x = region, y = enrollment, fill = region)) + 
  geom_boxplot() + 
  scale_fill_brewer(palette = "Dark2") +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "Region",
       y = "Enrollment",
       title = "Distribution of Enrollment by Region") + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90),
        plot.title = element_text(hjust = 0.5),
        legend.position = "none")
  
```

15. Create a boxplot showing graduation rates per region. Does anything stand out?

```{r}
ggplot(districts, aes(x = region, y = grad/100, fill = region)) + 
  geom_boxplot() +
  scale_fill_brewer(palette = "Dark2") +
  scale_y_continuous(breaks = seq(0, 1, by = 0.1), 
                     labels = scales::label_percent(accuracy = 1)) +
  labs(x = "Region",
       y = "Enrollment",
       title = "Distribution of Enrollment by Region") + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90),
        plot.title = element_text(hjust = 0.5),
        legend.position = "none")
```

16. Find the weighted average of graduation rates by region using enrollment as weights. Compare the results you get for the weighted average to what you see from the boxplots. Can you explain any discrepancy? **The outliers causing skew by region in terms of graduation rates are also the most enrolled, which pulls the means of each regional group away from its median.**

```{r}
districts %>% 
  filter(!is.na(grad), !is.na(enrollment)) %>% 
  group_by(region) %>%
  summarize(weight_mean_grad = weighted.mean(grad, enrollment))
```

17. For many districts, values for `alg_2` are lower than for `alg_1`. Create a histogram showing the distribution of differences (`alg_1` - `alg_2`). Which school had the largest drop from `alg_1` to `alg_2`? **Pickett County.** For what percentage of schools is it true that `alg_2` is larger than `alg_1`? **About 88%.** Is there a similar dropoff for `eng_2` and `eng_3`? **No, actually the opposite. Proficiency in English 3 is generally better.**


```{r}
algdiffdist <- districts %>%
  mutate(algdiff = alg_1 - alg_2)

ggplot(algdiffdist, aes(x = algdiff)) + 
  geom_histogram(bins = 20, 
                 color = "black", 
                 fill = "blue") +
  labs(x = "Difference in Algebra Proficiencies", 
       y = "Count",
       title = "Histogram of Difference in Algebra Proficiencies by District") +
  ylim(0,20) +
  xlim(-20,60)
```
```{r}
algdiffdist %>% 
  arrange(desc(algdiff)) %>% 
  top_n(1, algdiff)
```

```{r}
algdiffdist %>%
  filter(!is.na(eng_2), !is.na(eng_3)) %>% 
  mutate(engdiff = eng_3 - eng_2) %>% 
  summarize(perlarger = length(engdiff[engdiff > 0])/length(engdiff) * 100, meanlarger = mean(engdiff))
```


18. You may have noticed that a lot of rows are missing values. Which district has the largest number of missing values? **West Tennessee School for the Deaf.** What do you notice about schools that have a lot of missing values? **Their performance is generally poorer; they are smaller city districts with diverse populations that are substantially economically disadvantaged.**

```{r}
na_mask <- districts %>% 
  apply(MARGIN = 1, function(x) sum(is.na(x)))

print(districts[na_mask >= 10,])
```

```{r}
print(districts[na_mask == 15,])
```

19. Find the correlation between graduation rate and all other variables. Create a horizontal bar chart showing these correlations. Make sure that your plot is ordered by correlation values. What do you notice from these correlations? **Economic disadvantage and having a larger number of members of otherwise historically disadvantaged groups is very negatively correlated with graduation rates, unfortunately. Also, school attendance is a large part of graduation rates.**

```{r}
variable_label_vector <- c("English 3 Proficiency", 
                           "Science Proficiency", 
                           "Biology Proficiency",
                           "Algebra 2 Proficiency",
                           "Algebra 1 Proficiency",
                           "English 1 Proficiency",
                           "English 2 Proficiency",
                           "Math Proficiency",
                           "English Language Proficiency",
                           "Chemistry Proficiency",
                           "Composite ACT Scores",
                           "Percentage of Students With Disabilities",
                           "Percentage of Native American Students",
                           "Percentage of Economically Disadvantaged Students",
                           "Expenditures Per Student",
                           "Percentage of Chronically Absent Students",
                           "Percentage of Latina Students",
                           "Percentage of English Language Learners",
                           "Percentage of Expelled Students",
                           "Total Enrollment",
                           "Percentage of African-American Students",
                           "Percentage of Suspended Students",
                           "Percentage of Dropouts")

cor_mat <- districts %>%
  select(3:26) %>%
  cor(y = districts['grad'], use = "complete.obs") 

cor_mat <- tibble(variable = rownames(cor_mat), correlation = cor_mat[1:24])

cor_mat <- cor_mat %>%
  arrange(desc(correlation))

ggplot(cor_mat[2:24,], aes(correlation, reorder(variable, correlation), fill = variable)) +
  geom_col() +
  labs(x = "Correlation",
       y = "Variable",
       title = "Correlations with Graduation Rate") +
  theme(legend.position = "none") +
  xlim(-1,1) +
  scale_y_discrete(labels = rev(variable_label_vector))
  

```


20. Create a scatterplot for `grad` vs. `suspended`. Does what you see make sense given your answer from the previous part? **The negative correlation between the two variables is probably overstated but still holds. It's important to understand what "suspended" means in this context, and for how long. But suspensions are probably a signal for another factor or other factors more integral to graduation rates.**



```{r}

ggplot(districts, aes(grad, suspended)) + 
  geom_point() + 
  geom_smooth(method = 'lm') +
  labs(x = "Graduation Rate",
       y = "Percentage of Suspended Students",
       title = "Scatterplot of Graduation Rate vs. Suspensions")
```


21. Create a linear regression model using `lm` with target variable `grad` and predictor variable `suspended`. What R^2 value does this model have? **0.0795** What is the interpretation of this number? **That only about 8% of the variation in graduation rates can explained by the rate of suspensions in TN school districts.**

```{r}

lm_model = lm(grad ~ suspended, data = districts)
summary(lm_model)

```


22. Add the regression line to your scatterplot using `geom_smooth` with `method='lm'`. How do you feel about the regression line after seeing it plotted on the scatterplot? **See above under 20. That regression line is likely a very poor fit for this data.**

**Continued Exploration and Practice**

23. Read in the school-level testing data for 2014, available [here](https://www.tn.gov/content/dam/tn/education/data/data_2014_school_base.xlsx). You might find the readxl library useful for this task. If you use this library, be sure to look at the `na` argument for the `read_excel` function.

```{r}
library(readxl)

testing <- read_excel("data/data_2014_school_base.xlsx", na = c("", "*", "**"))
```

```{r}
testing
```


24. How many schools have at least 20 percent of students below bsc for Algebra I? **71** Which districts do these schools belong to? **A variety. Only trend is that larger inner city districts are generally represented.**

```{r}
testing %>% 
  filter(grade == "All Grades", 
         subgroup == "All Students", 
         subject == "Algebra I", 
         pct_below_bsc >= 20) %>% 
  count()
```


```{r}
testing %>% 
  filter(grade == "All Grades", 
         subgroup == "All Students", 
         subject == "Algebra I", 
         pct_below_bsc >= 20) %>% 
  distinct(system_name)
```


25. How many schools have at least 20 percent of students below bsc for _both_ Algebra I and English I? **4**

```{r}
testing %>% 
  filter(grade == "All Grades", 
         subgroup == "All Students", 
         subject == "English I" | subject == "Algebra I", 
         pct_below_bsc >= 20) %>% 
  select("system_name", "school_name", "subject", "pct_below_bsc") %>% 
  pivot_wider(names_from = "subject", values_from = "pct_below_bsc") %>% 
  rename(English_I = "English I", Algebra_I = "Algebra I") %>% 
  filter(!is.na(English_I) & !is.na(Algebra_I)) %>% 
  count()
```

26. Which grade has the highest pct_adv for Algebra I? **8.** Plot the average pct_adv per grade level as a bar chart. Make sure that the bars are ordered by grade level.

```{r}
alg1_adv <- testing %>%
  filter(grade != "All Grades",
         subgroup == "All Students",
         subject == "Algebra I",
         !is.na(pct_adv)) %>% 
  group_by(grade) %>%
  summarize(avg_pct_adv = sum(pct_adv)/n()) %>% 
  mutate(grade = as.numeric(grade)) %>% 
  arrange(grade)
```


```{r}
ggplot(alg1_adv, aes(x = grade, y = avg_pct_adv/100, fill = factor(grade))) + 
  geom_col() +
  scale_fill_viridis(discrete = TRUE) +
  ylim(0, 40) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.1), 
                     labels = scales::label_percent(accuracy = 1)) +
  labs(x = "Grade Level",
       y = "Average Percentage",
       title = "Percentages of Algebra 1 Advancement Level by Grade") +
  theme(legend.position = 'none',
        panel.background = element_rect(fill = "#FFFFFF"),
        panel.grid.major = element_line(color = "#000000", 
                                        linetype = "dashed"))
```

27. Find the correlation between pct_adv for Algebra I and pct_adv for Algebra II by school. Create a scatterplot showing Algebra II scores vs. Algebra I scores by school.

```{r}

corr_alg <- testing %>%
  filter(grade == "All Grades", 
         subgroup == "All Students", 
         subject == "Algebra I" | subject == "Algebra II") %>% 
  select("system_name", "school_name", "subject", "pct_adv") %>% 
  filter(!is.na(pct_adv)) %>% 
  pivot_wider(names_from = subject, values_from = pct_adv) %>% 
  rename(Algebra_I = "Algebra I", Algebra_II = "Algebra II") %>% 
  filter(!is.na(Algebra_I) & !is.na(Algebra_II))

specific_corr_mat <- corr_alg %>% 
  select(Algebra_I, Algebra_II) %>% 
  cor()

print(specific_corr_mat[1, 2])

ggplot(corr_alg, aes(x = Algebra_I, y = Algebra_II, color = Algebra_II)) + 
  geom_point(shape = 20, size = 4) +
  labs(x = "% Algebra I Advancement Level",
       y = "% Algebra II Advancement Level",
       title = "Scatterplot of Algebra I vs. Algebra II Advancement Level") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "#FFFFFF"),
        panel.grid.major = element_blank()) + 
  ylim(0,80) +
  xlim(0,80) + 
  scale_color_viridis_c()
```
```{r}
corr_alg %>% 
  rowwise() %>% 
  mutate(coralg = Algebra_II/Algebra_I)
```

28. Find all schools in Rutherford County that have "High School" in their name. For these schools, create a chart (your choice) showing the differences in pct_below_bsc, pct_bsc, pct_prof, and pct_adv for Algebra I when looking across all subgroups and grades.

```{r}
just_rutherford_high <- testing %>% 
  filter(grepl("Rutherford", system_name),
         grepl("High School", school_name),
         subject == "Algebra I",
         subgroup == "All Students",
         grade == "All Grades") %>%
  select(school_name, pct_below_bsc, pct_bsc, pct_prof, pct_adv) %>% 
  pivot_longer(cols = c(pct_below_bsc, pct_bsc, pct_prof, pct_adv), 
               names_to = "Level",
               values_to = "Percentage")


ggplot(just_rutherford_high, 
       aes(x = school_name, 
           y = Percentage,
           fill = Level)) + 
  geom_col(position = "dodge") + 
  scale_fill_discrete(label = c("Advanced", 
                                "Below Basic", 
                                "Basic", 
                                "Proficient")) + 
  ylim(0, 50) +
  labs(x = "School Name",
       title = "Algebra I Testing Levels for Rutherford County High Schools") + 
  theme_classic() +
  theme(axis.text.x = element_text(family = "Times", 
                                   hjust = 1, 
                                   vjust = 1, 
                                   angle = 55),
        plot.title = element_text(hjust = 0.5))

```


29. I claim that smaller schools do a better job preparing students for Algebra I standardized tests. Find the average number of valid tests (a proxy for the school size) for schools where the pct_prof_adv for Algebra I is greater than 95. Compare this to the average number of valid tests for all schools. In light of this result, how does my claim look? **Pretty good, actually, as the mean number of valid tests for schools with a high proficient advanced level percentage for Algebra I is 48 vs. 130.** 

```{r}
vt_95 <- testing %>% 
  filter(subject == "Algebra I",
         subgroup == "All Students",
         grade == "All Grades",
         pct_prof_adv > 95) %>%
  select(system_name, school_name, valid_tests, pct_prof_adv) %>% 
  summarize(valid_tests_95_and_above = mean(valid_tests, na.rm = TRUE))

vt <- testing %>% 
  filter(subject == "Algebra I",
         subgroup == "All Students",
         grade == "All Grades") %>%
  select(system_name, school_name, valid_tests) %>% 
  summarize(valid_tests_generally = mean(valid_tests, na.rm = TRUE))

print(vt_95)
print(vt)
```

30. I also claim that smaller schools do a worse job preparing students for Algebra I standardized tests. Find the average number of valid tests (a proxy for the school size) for schools where the pct_prof_adv for Algebra I is less than 25. Compare this to the average number of valid tests for all schools. In light of this result, how does my claim look now? **Unclear. The average number of valid tests for Algebra I where the proficient advanced is less than 25% is 62.**

```{r}
vt_25 <- testing %>% 
  filter(subject == "Algebra I",
         subgroup == "All Students",
         grade == "All Grades",
         pct_prof_adv < 25) %>%
  select(system_name, school_name, valid_tests, pct_prof_adv) %>% 
  summarize(valid_tests_25_and_below = mean(valid_tests, na.rm = TRUE))

print(vt_25)
```


31. Create a scatterplot showing pct_prov_adv vs. valid_tests. Can you use this to explain the result for numbers 26 and 27? **There's probably a very weak, if positive, correlation between the two.**

```{r}
vts_ppa_alg <- testing %>% 
  filter(subject == "Algebra I",
         subgroup == "All Students",
         grade == "All Grades") %>%
  select(system_name, school_name, valid_tests, pct_prof_adv)

ggplot(vts_ppa_alg, aes(x = valid_tests, y = pct_prof_adv/100)) + 
  geom_point(shape = 20, size = 2, color = "brown") +
  labs(x = "Percentage of Proficient Advanced Level in Algebra I",
       y = "Number of Valid Tests",
       title = "Algebra I Proficient Advanced Level vs. Valid Tests by TN School") +
  theme(axis.ticks = element_blank(),
        panel.background = element_rect(fill = '#f4efc4'),
        panel.grid.minor = element_blank()) +
  geom_smooth() +
  scale_y_continuous(breaks = seq(0, 1, by = 0.1), 
                     labels = scales::label_percent(accuracy = 1)) +
  xlim(0, 600) +
  ylim(0, 1)
```

If you finish all of the above questions, continue to explore the two datasets and see what else interesting you can find.

```{r}
for (testing_sn in testing["system_name"]){
  for (districts_sn in districts["system_name"]){
    if (startsWith(substr(testing_sn, 1, 4),substr(districts_sn, 1, 4))) {
      testing$system_name[testing$system_name == testing_sn] <- districts_sn
    }
  }
}

td_merged <- testing %>% 
  filter(grade == "All Grades",
         subgroup == "All Students") %>% 
  left_join(districts, by = "system_name") %>% 
  select(-c(year, 
            system.x, 
            system.y, 
            school, 
            grade, 
            subgroup))

write_csv(td_merged, 'data/td_merged.csv')
```
Also, check out the plotly library for R. The `ggplotly` function makes it very easy to convert ggplot plots into interactive plotly plots.